# 1.5.3 åœ¨äº¤å‰è¡¨é‡Œåˆ¶ä½œåµŒå¥—å¼è¡¨ä¾§æ 

## é—®é¢˜:
### å‡†å¤‡æ•°æ®:
```sql
create table tbl_age(
    age_class int not null, -- å¹´é¾„å±‚çº§
    age_range varchar(100) not null -- å¹´é¾„
);
insert into tbl_age(age_class, age_range)
                    values(1, '21å²~30å²'),
                            (2, '31å²~40å²'),
                            (3, '41å²~50å²');
/*
 age_class | age_range
-----------+-----------
         1 | 21å²~30å²
         2 | 31å²~40å²
         3 | 41å²~50å²
(3 rows)
*/

create table tbl_sex(
    sex_cd varchar(10) not null, -- æ€§åˆ«ç¼–å·
    sex varchar(10) -- æ€§åˆ«
);
insert into tbl_sex(sex_cd, sex)
            values('m', 'ç”·'),
                    ('f', 'å¥³');
/*
 sex_cd | sex
--------+-----
 m      | ç”·
 f      | å¥³
(2 rows)
*/

create table tbl_pop(
    pref_name varchar(100) not null,
    age_class int not null,
    sex_cd  varchar(100) not null,
    population int not null
);
insert into tbl_pop(pref_name, age_class, sex_cd, population)
            values('ç§‹ç”°', 1, 'm', 400),
                    ('ç§‹ç”°', 3, 'm', 1000),
                    ('ç§‹ç”°', 1, 'f', 800),
                    ('ç§‹ç”°', 3, 'f', 1000),
                    ('é’æ£®', 1, 'm', 700),
                    ('é’æ£®', 1, 'f', 500),
                    ('é’æ£®', 3, 'f', 800),
                    ('ä¸œäº¬', 1, 'm', 900),
                    ('ä¸œäº¬', 1, 'f', 1500),
                    ('ä¸œäº¬', 3, 'f', 1200),
                    ('åƒå¶', 1, 'm', 900),
                    ('åƒå¶', 1, 'f', 1000),
                    ('åƒå¶', 3, 'f', 900);
/*
 pref_name | age_class | sex_cd | population
-----------+-----------+--------+------------
 ç§‹ç”°      |         1 | m      |        400
 ç§‹ç”°      |         3 | m      |       1000
 ç§‹ç”°      |         1 | f      |        800
 ç§‹ç”°      |         3 | f      |       1000
 é’æ£®      |         1 | m      |        700
 é’æ£®      |         1 | f      |        500
 é’æ£®      |         3 | f      |        800
 ä¸œäº¬      |         1 | m      |        900
 ä¸œäº¬      |         1 | f      |       1500
 ä¸œäº¬      |         3 | f      |       1200
 åƒå¶      |         1 | m      |        900
 åƒå¶      |         1 | f      |       1000
 åƒå¶      |         3 | f      |        900
(13 rows)
*/
```

### é—®é¢˜:
ç”ŸæˆåµŒå¥—å¼è¡¨ä¾§æ çš„ç»Ÿè®¡è¡¨:

<img width="194" alt="p79åŒ…å«åµŒå¥—å¼è¡¨ä¾§æ çš„ç»Ÿè®¡è¡¨" src="https://user-images.githubusercontent.com/19871320/71862137-d4b5d180-3133-11ea-8de7-92debedb44fc.png">

```textmate
age_range | sex | pop_tohoko | pop_kanto
-----------+-----+------------+-----------
 21å²~30å² | ç”·  |       1100 |      1800
 21å²~30å² | å¥³  |       1300 |      2500
 31å²~40å² | ç”·  |            |
 31å²~40å² | å¥³  |            |
 41å²~50å² | ç”·  |       1000 |
 41å²~50å² | å¥³  |       1800 |      2100
```

## è§£æ³•:

ğŸ¤“ä¹¦ä¸Šä½¿ç”¨cross joinè¯­å¥(æœ‰çš„æ•°æ®åº“ä¸æ”¯æŒcross join), ä½†æ˜¯ä½¿ç”¨inner joinä¹Ÿè¡Œ
```sql
select age_sex.age_range as age_range,
        age_sex.sex as  sex,
        case when sum(case when tbl_pop.pref_name  in ('é’æ£®', 'ç§‹ç”°') then population else 0 end) > 0
                then sum(case when tbl_pop.pref_name  in ('é’æ£®', 'ç§‹ç”°') then population else 0 end)
            else null end  as pop_tohoko,
        case when sum(case when tbl_pop.pref_name in ('ä¸œäº¬', 'åƒå¶') then population else 0 end) > 0
                then sum(case when tbl_pop.pref_name in ('ä¸œäº¬', 'åƒå¶') then population else 0 end)
            else null end  as pop_kanto
    from (select * from tbl_sex, tbl_age) as age_sex
        left outer join tbl_pop
            on tbl_pop.age_class = age_sex.age_class
            and age_sex.sex_cd = tbl_pop.sex_cd
group by age_sex.age_range, age_sex.sex
order by age_range, sex desc;
/*
 age_range | sex | pop_tohoko | pop_kanto
-----------+-----+------------+-----------
 21å²~30å² | ç”·  |       1100 |      1800
 21å²~30å² | å¥³  |       1300 |      2500
 31å²~40å² | ç”·  |            |
 31å²~40å² | å¥³  |            |
 41å²~50å² | ç”·  |       1000 |
 41å²~50å² | å¥³  |       1800 |      2100
*/
```



















